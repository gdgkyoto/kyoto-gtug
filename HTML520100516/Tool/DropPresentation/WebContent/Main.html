<!DOCTYPE html>
<html lang="ja"> 
<head> 
	<meta charset="utf-8"> 
	<script type="text/javascript" src="js/jquery-1.4.2.min.js"></script>
	<script type="text/javascript" src="js/jquery-ui-1.8.1.custom.min.js"></script>
	<script type="text/javascript" src="js/base64.js"></script>
	<script type="text/javascript" src="js/canvas2image.js"></script>
	<link type="text/css" rel="stylesheet" href="css/ui-lightness/jquery-ui-1.8.1.custom.css"></link>
	
	<title>ドロッププレゼンテーション</title>
<script type="text/javascript">

var drawFlag = false;
var oldX = 0;
var oldY = 0;

window.addEventListener("load", function() {
	var myCanvas = document.getElementById("myCanvas");
	myCanvas.addEventListener("mousemove", draw, false);

	myCanvas.addEventListener("mousedown", function(e) {
		drawFlag = true;
		//console.log("mousedown : " + drawFlag);
		oldX = e.clientX;
		oldY = e.clientY;
	}, false);

	myCanvas.addEventListener("mouseup", function() {
		drawFlag = false;
		//console.log("mouseup : " + drawFlag);
	}, false);

	myCanvas.addEventListener("dblclick", function(e) {
		//console.log("dbclick");
		
		document.getElementById("inputText").value = "";
		
		$('#dialog').dialog({
		    bgiframe: true,
		    autoOpen: true,
		    width: 200,
		    modal: false,
		    buttons: {
		        'OK': function() {
					var myCanvas = document.getElementById("myCanvas");
					var context = myCanvas.getContext("2d");
					var x = e.clientX;
					var y = e.clientY;
					var text = document.getElementById("inputText").value;
					context.font = "10px";
					context.fillText(text, x, y);
					$(this).dialog("close");
		        }
		    }
		});		
	}, false);

	myCanvas.addEventListener("dragenter", function(e) {
		//console.log("dragenter");
		e.stopPropagation();
		e.preventDefault();
	}, false);

	myCanvas.addEventListener("dragover", function(e) {
		//console.log("dragover");
		e.stopPropagation();
		e.preventDefault();
	}, false);

	myCanvas.addEventListener("drop", function(e) {
		//console.log("drop");
		var dt = e.dataTransfer;
		var files = dt.files;
		if (files.length <= 0) return false;
		var file = files[0];
		//if (file.type.match(/image.*/)) { 
			var img = new Image();
			var dataURLReader = new FileReader();
		    dataURLReader.onloadend = function() {
		        img.src = dataURLReader.result;
		        drawImage(img, e.clientX, e.clientY);
		    }
		    dataURLReader.readAsDataURL(file);
		//}
		e.stopPropagation();
	}, false);

}, false);

function draw(e) {
	//console.log("mousemove : " + drawFlag);
	if (!drawFlag) return;
	var x = e.clientX;
	var y = e.clientY;
	var myCanvas = document.getElementById("myCanvas");
	var context = myCanvas.getContext("2d");
	context.strokeStyle = "rgba(255,0,0,1)";
	context.lineWidth = 1;
	context.beginPath();
	context.moveTo(oldX, oldY);
	context.lineTo(x, y);
	context.stroke();
	context.closePath();
	oldX = x;
	oldY = y;
}

function drawImage(img, x, y) {
	var myCanvas = document.getElementById("myCanvas");
	var context = myCanvas.getContext("2d");
	img.onload = function() {
		context.drawImage(img, x, y);
	}
}

function saveData() {
	var myCanvas = document.getElementById("myCanvas");
	Canvas2Image.saveAsPNG(myCanvas);
	/*
	var data = myCanvas.toDataURL("image/png");
	data = data.replace("image/png", "image/octet-stream");
	window.open(data, "save");
	*/
}
</script>
</head> 
<body> 
	<canvas id="myCanvas" width="640" height="480" draggable="true" style="-webkit-user-drag: element; border: 1px solid gray;"> 
		HTML 5　Canvasに対応したブラウザを使用してください。
	</canvas>
	<div id="dialog" title="テキスト" style="display : none;">
    	<input type="text" name="inputText" id="inputText" size="20" />
	</div>
	<div id="menu">
		<button onclick="drawImage()"">画像</button>
		<button onclick="saveData()">保存</button>
	</div>
</body> 
</html>