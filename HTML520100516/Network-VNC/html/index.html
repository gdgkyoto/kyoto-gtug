<!doctype html>
<html>
<head>
<link type="text/css" href="common.css" rel="stylesheet">
<script src="websocket.js" type="text/javascript"></script>
<script src="file_upload.js" type="text/javascript"></script>
<script src="file_download.js" type="text/javascript"></script>
<script src = 'jquery-1.4.2.js' type = 'text/javascript'></script>

<script type="text/javascript"><!--

    //---------------------------------------------------
    // 接続
    var protocol=(location.protocol=="https:")?"wss":"ws";
    var host=location.host;
    var ws;

    // 初期化
    var screenImage ;
    var imageRequestTimer=null;

    // 切断処理
    $(window).unload(function(){
      ws.close();
    });

	// 画面更新タイマー
    function setImageRequestTimer(milliseconds){
    	console.log("setImageRequestTimer start");
    	if(imageRequestTimer!=null){
    		clearTimeout(imageRequestTimer);
    	}
   		imageRequestTimer=setTimeout(function(){
   			updateImage();
   		},milliseconds);
    	console.log("setImageRequestTimer end");
    }

	// 手動の画面更新
    function refresh(){
//        ws.send( $('#in').val() );
        sendMessage('IMAGE_REQUEST', 0, '');
    }

    // HTMLロード完了時の処理
    $(function(){
    	console.log("onLoad start");
    	
    	ws = new WebSocket(protocol+"://"+host+"/ws/");
        // データ受信時の処理
        ws.onmessage = function(m) {
          // 受信データをimgタグに反映
          screenImage.setAttribute("src","data:image/jpg;base64,"+m.data);
        };

    	
        screenImage = document.getElementById("screen");
        setImageRequestTimer(500);

        console.log("onLoad end");
        initFileUpload();
    });

    // 画面更新
    function updateImage(){
    	console.log("updateImage start "+ws.send);
//        var v = $('#in').val(); 
    
    	
        // 画面更新要求
    	sendMessage('IMAGE_REQUEST', 0, '');

    	// 500ミリ秒後に再度画面更新
    	setImageRequestTimer(500);
    	console.log("updateImage end");
    }

    function sendMessage(type, seq, data) {
        ws.send([type, seq, new Date().getTime(), data].join('|'));
    }
    function debugSend(){
        var type = $('#debug_type').val();
        var data = $('#debug_data').val();
        sendMessage(type, 0, data);
    }

--></script>

<title>WebSocketRemote</title>
</head>
<body style="height:1000px;">
<div id="content">AAA</div>
<div id="hashtag">BBB</div>
<input type="button" onClick="refresh()" value="refresh"/>
<input type="text" id="in" />
<br/>
<input type="button" onClick="debugSend()", value="debug send"/>
<input type="text" id="debug_type" />
<input type="text" id="debug_data" />
<div id="text" style="width:200px; height:200px; border:1px solid gray;"></div>
<img id="screen" src="gtug210x85.png" />
</body>
</html>