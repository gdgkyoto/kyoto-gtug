<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript" charset="utf-8" src="jquery-1.4.2.js"></script>
	</head>
	<body>
		<script>
			// Access localStorage
			function numOfRes(){
				return localStorage["numberOfResults"] |= 3;				
			}

			// Reference code
			// http://src.chromium.org/viewvc/chrome/trunk/src/chrome/common/extensions/docs/examples/howto/contentscript_xhr/
			
			
			
			// Bing Search
			function bingSearch(response, query, callback){
				var params = {
					Appid: 'F86569E3A5245BCD131B9E5A90939CFCF65E92CC',
					query: query,
					sources: 'web',
					'web.count': numOfRes()
//					'web.offset': 100
				}
				$.ajax({
					type: 'GET',
					url: "http://api.search.live.net/json.aspx",
					data: params,
					dataType: 'json',
					success: function(res){
						var results = res.SearchResponse.Web.Results;
						var data = [];
						for (var i=0; i < Math.min(numOfRes(), results.length); i++) {
							data.push({
								title: results[i].Title, 
								url: results[i].Url
							})
						}
						response.push({
							'engine': 'Bing',
							'total': res.SearchResponse.Web.Total,
							'data': data
						})
						callback();
					},
					error: function(xhr, textStatus, errorThrown){
						console.log(errorThrown);
					}
				})				
			}

			// Yahoo! Search
			// res: Results of google search API
			var yahooSearchCallback = function(res) {
				console.log("yahooSearchCallback");
				console.log(res);
				if (!yahooSearchCallback.response)
					throw { error: "response is not set to yahooSearchCallback" }
				if (!yahooSearchCallback.callback)
					throw { error: "callback is not set to yahooSearchCallback" }

				var results = res.ResultSet.Result;
				var data = [];
				for (var i=0; i < Math.min(numOfRes(), results.length); i++) {
					data.push({
						title: results[i].Title, 
						url: results[i].Url
					})
				}
				yahooSearchCallback.response.push({
					'engine': 'Yahoo!',
					'total': res.ResultSet.totalResultsAvailable,
					'data': data
				})

				yahooSearchCallback.callback();
			}
			function yahooSearch(response, query, callback){
				yahooSearchCallback.response = response;
				yahooSearchCallback.callback = callback;
				
				var appid = 'zdksqkOxg65uC2CemuYVRiO7QhAbtJUTt9JsIBxADGnXNK0cKPf2FO0dcdTbpD_zqWau';
				var script = document.createElement('script');
				script.setAttribute('type', 'text/javascript');
				script.setAttribute('src', [
					'http://search.yahooapis.jp/WebSearchService/V1/webSearch',
					'?appid=', encodeURIComponent(appid),
					'&query=', encodeURIComponent(query),
					'&results=', numOfRes(),
					'&output=json',
					'&callback=yahooSearchCallback'
					].join(''));
				script.setAttribute('charset', 'UTF-8');
				document.body.appendChild(script);
			}
			
			// Google Search			
			// res: Results of google search API
			function googleSearchCallback(res)
			{
				console.log("googleSearchCallback");
				console.log(res);
				if (!googleSearchCallback.response)
					throw { error: "response is not set to googleSearchCallback" }
				if (!googleSearchCallback.callback)
					throw { error: "callback is not set to googleSearchCallback" }

				var results = res.responseData.results;
				var data = [];
				for (var i=0; i < Math.min(numOfRes(), results.length); i++) {
					data.push({
						title: results[i].title, 
						url: results[i].url
					})
				}
				googleSearchCallback.response.push({
					'engine': 'Google',
					'total': res.responseData.cursor.estimatedResultCount,
					'data': data
				})
				googleSearchCallback.callback();
			}
			function googleSearch(response, query, callback)
			{
				googleSearchCallback.response = response;
				googleSearchCallback.callback = callback;

				var appid = 'ABQIAAAAIWerzbncqqoIPMsGqlPItRQMvVaHn46sKFEB-9OpdaAgTkqXtBQQ_iLPa_Kues42K0wHkoyq-cFdUw';
				var script = document.createElement('script');
				script.setAttribute('type', 'text/javascript');
				script.setAttribute('src', [
					'http://ajax.googleapis.com/ajax/services/search/web',
					'?key=', encodeURIComponent(appid),
					'&q=', encodeURIComponent(query),
					'&v=1.0',
					'&rsz=large',
					'&callback=googleSearchCallback'
				].join(''));
				script.setAttribute('charset', 'UTF-8');
				document.body.appendChild(script);
			}
			
			// Do search many search engines, and return resuls
			// query: search query
			// callback: 
			function fetchSearchResult(query, callback) {
				console.log('fetchSearchResult');
				console.log('localStorage["numberOfResults"]=' + numOfRes());
				
				var results = [];
				bingSearch(results, query, function(){
					yahooSearch(results, query, function(){
						googleSearch(results, query, function(){
							callback(results);							
						})
					});
				});
			};
			// handler of message passing
			// Argument
			// action: name of command
			//         refer to each function for the command
			function onRequest(request, sender, callback) {
				console.log('onRequest');
				if (request.action == 'fetchSearchResult') {
					fetchSearchResult(request.query, callback);
				}
			};
			// regist onResult as message passing
			chrome.extension.onRequest.addListener(onRequest);
		</script>
	</body>
</html>

