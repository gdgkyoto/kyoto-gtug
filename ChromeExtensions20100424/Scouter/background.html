<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript" charset="utf-8" src="jquery-1.4.2.js"></script>
	</head>
	<body>
		<script>
			// 参考コード
			// http://src.chromium.org/viewvc/chrome/trunk/src/chrome/common/extensions/docs/examples/howto/contentscript_xhr/

			function bingSearch(response, query, callback){
				var params = {
					Appid: 'F86569E3A5245BCD131B9E5A90939CFCF65E92CC',
					query: query,
					sources: 'web',
					'web.count': 3
//					'web.offset': 100
				}
				$.ajax({
					type: 'GET',
					url: "http://api.search.live.net/json.aspx",
					data: params,
					dataType: 'json',
					success: function(res){
						var results = res.SearchResponse.Web.Results;
						response.push({
							'engine': 'Bing',
							'total': res.SearchResponse.Web.Total,
							'data': [
								{title: results[0].Title, url: results[0].Url},
								{title: results[1].Title, url: results[1].Url},
								{title: results[2].Title, url: results[2].Url}
							]							
						})
						callback();
					},
					error: function(xhr, textStatus, errorThrown){
						console.log(errorThrown);
					}
				})				
			}

			// http://search.yahooapis.jp/WebSearchService/V1/webSearch?appid=zdksqkOxg65uC2CemuYVRiO7QhAbtJUTt9JsIBxADGnXNK0cKPf2FO0dcdTbpD_zqWau&query=YAHOO&results=2&output=json
			// Yahoo! 検索
			// data: APIで取得した検索結果
			var yahooSearchCallback = function(data) {
				console.log("yahooSearchCallback");
				console.log(data);
				if (!yahooSearchCallback.response)
					throw { error: "yahooSearchCallbackにresonseがセットされていません" }
				if (!yahooSearchCallback.callback)
					throw { error: "yahooSearchCallbackにcallbackがセットされていません" }

				var results = data.ResultSet.Result;
				yahooSearchCallback.response.push({
					'engine': 'Yahoo!',
					'total': data.ResultSet.totalResultsAvailable,
					'data': [
						{title: results[0].Title, url: results[0].Url},
						{title: results[1].Title, url: results[1].Url},
						{title: results[2].Title, url: results[2].Url}
					]
				})

				yahooSearchCallback.callback();
			}
			function yahooSearch(response, query, callback){
				yahooSearchCallback.response = response;
				yahooSearchCallback.callback = callback;
				
				var appid = 'zdksqkOxg65uC2CemuYVRiO7QhAbtJUTt9JsIBxADGnXNK0cKPf2FO0dcdTbpD_zqWau';
				var script = document.createElement('script');
				script.setAttribute('type', 'text/javascript');
				script.setAttribute('src', [
					'http://search.yahooapis.jp/WebSearchService/V1/webSearch',
					'?appid=', encodeURIComponent(appid),
					'&query=', encodeURIComponent(query),
					'&results=3',
					'&output=json',
					'&callback=yahooSearchCallback'
					].join(''));
				script.setAttribute('charset', 'UTF-8');
				document.body.appendChild(script);
			}
			
			// Google 検索			
			// data: APIで取得した検索結果
			function googleSearchCallback(data)
			{
				console.log("googleSearchCallback");
				console.log(data);
				if (!googleSearchCallback.response)
					throw { error: "googleSearchCallbackにresonseがセットされていません" }
				if (!googleSearchCallback.callback)
					throw { error: "googleSearchCallbackにcallbackがセットされていません" }

				var results = data.responseData.results;
				googleSearchCallback.response.push({
					'engine': 'Google',
					'total': data.responseData.cursor.estimatedResultCount,
					'data': [
						{title: results[0].title, url: results[0].url},
						{title: results[1].title, url: results[1].url},
						{title: results[2].title, url: results[2].url}
					]
				})
				googleSearchCallback.callback();
			}
			function googleSearch(response, query, callback)
			{
				googleSearchCallback.response = response;
				googleSearchCallback.callback = callback;

				var appid = 'ABQIAAAAIWerzbncqqoIPMsGqlPItRQMvVaHn46sKFEB-9OpdaAgTkqXtBQQ_iLPa_Kues42K0wHkoyq-cFdUw';
				var script = document.createElement('script');
				script.setAttribute('type', 'text/javascript');
				script.setAttribute('src', [
					'http://ajax.googleapis.com/ajax/services/search/web',
					'?key=', encodeURIComponent(appid),
					'&q=', encodeURIComponent(query),
					'&v=1.0',
//					'&rsz=large',
					'&callback=googleSearchCallback'
				].join(''));
				script.setAttribute('charset', 'UTF-8');
				document.body.appendChild(script);
			}
			
			// 複数の検索エンジンに対して検索を行い、結果を返す。
			// query: 検索クエリ
			// callback: コールバック
			function fetchSearchResult(query, callback) {
				console.log('fetchSearchResult');
				
				var results = [];
				bingSearch(results, query, function(){
					yahooSearch(results, query, function(){
						googleSearch(results, query, function(){
							callback(results);							
						})
					});
				});
			};
			// message passing のハンドラ
			// 引数
			// action: 実行する命令の名前
			//         命令についてはそれぞれの関数を参照
			function onRequest(request, sender, callback) {
				console.log('onRequest');
				if (request.action == 'fetchSearchResult') {
					fetchSearchResult(request.query, callback);
				}
			};
			// onResultをmessage passingのハンドラとして登録
			chrome.extension.onRequest.addListener(onRequest);
		</script>
	</body>
</html>

